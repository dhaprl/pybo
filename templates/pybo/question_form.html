{% extends 'base.html' %}

{% block content %}

{% comment %} 이미지 등록 팝업창 {% endcomment %}
<div id="uploadModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">이미지 업로드</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        {% comment %} 첫 번째 이미지 드래그 앤 드롭 {% endcomment %}
                        <div id="drop-zone1" class="border border-primary rounded d-flex justify-content-center align-items-center p-3" style="height: 150px; position: relative;">
                            <div class="drop-text">image 1 drop or click.</div>
                            <input type="file" id="image1" class="file-input w-100 h-100 position-absolute" accept="image/*" style="opacity: 0; cursor: pointer;">
                            <img id="preview-image1" class="img-fluid" style="display: none;" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        {% comment %} 네 번째 이미지 드래그 앤 드롭 {% endcomment %}
                        <div id="drop-zone4" class="border border-primary rounded d-flex justify-content-center align-items-center p-3" style="height: 150px; position: relative;">
                            <div class="drop-text">image 4 drop or click.</div>
                            <input type="file" id="image4" class="file-input w-100 h-100 position-absolute" accept="image/*" style="opacity: 0; cursor: pointer;">
                            <img id="preview-image4" class="img-fluid" style="display: none;" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        {% comment %} 두 번째 이미지 드래그 앤 드롭 {% endcomment %}
                        <div id="drop-zone2" class="border border-primary rounded d-flex justify-content-center align-items-center p-3" style="height: 150px; position: relative;">
                            <div class="drop-text">image 2 drop or click.</div>
                            <input type="file" id="image2" class="file-input w-100 h-100 position-absolute" accept="image/*" style="opacity: 0; cursor: pointer;">
                            <img id="preview-image2" class="img-fluid" style="display: none;" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% comment %} 세 번째 이미지 드래그 앤 드롭 {% endcomment %}
                        <div id="drop-zone3" class="border border-primary rounded d-flex justify-content-center align-items-center p-3" style="height: 150px; position: relative;">
                            <div class="drop-text">image 3 drop or click.</div>
                            <input type="file" id="image3" class="file-input w-100 h-100 position-absolute" accept="image/*" style="opacity: 0; cursor: pointer;">
                            <img id="preview-image3" class="img-fluid" style="display: none;" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary confirm-btn" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>

{% comment %} 질문 등록/수정 폼 {% endcomment %}
<div class="container">
    <form id="questionForm" method="post" class="post-form my-3" enctype="multipart/form-data">
        {% csrf_token %} <!-- 보안을 위한 CSRF 토큰 추가 -->

        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
                {% for field in form %}
                    {% if field.errors %}
                        <strong>{{ field.label }}</strong>
                        {{ field.errors }}
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-group mb-3">
            <label for="subject">제목</label>
            <input type="text" name="subject" id="subject" class="form-control" value="{{ form.subject.value|default_if_none:'' }}">
        </div>

        <div class="form-group mb-3">
            <label for="content">내용</label>
            <textarea name="content" id="content" class="form-control" rows="10">{{ form.content.value|default_if_none:'' }}</textarea>
        </div>

        {% comment %} 이미지 업로드 버튼 {% endcomment %}
        <button type="button" id="uploadBtn" class="btn btn-secondary mt-3" data-toggle="modal" data-target="#uploadModal">
            {% if form.instance.pk %}
            이미지 새로 등록 및 확인
            {% else %}
            이미지 등록 및 보기
            {% endif %}
        </button>

        {% comment %} 모델 선택 {% endcomment %}
        {% comment %} <h5 class="my-3 border-bottom pb-2">모델 선택</h5>
        <div class="form-group mb-3">
            <label for="detectors">탐지기 (Detectors)</label><br>
            <input type="checkbox" name="detectors" value="dlib" id="dlib_detector">
            <label for="dlib_detector">Dlib</label><br>
            <input type="checkbox" name="detectors" value="yolo" id="yolo_detector">
            <label for="yolo_detector">YOLO</label><br>
            <input type="checkbox" name="detectors" value="mtcnn" id="mtcnn_detector">
            <label for="mtcnn_detector">MTCNN</label>
        </div>

        <div class="form-group mb-3">
            <label for="predictors">예측기 (Predictors)</label><br>
            <input type="checkbox" name="predictors" value="fairface" id="fairface_predictor">
            <label for="fairface_predictor">FairFace</label>
        </div> {% endcomment %}

        {% comment %} 등록/수정 버튼 {% endcomment %}
        <button type="submit" class="btn btn-primary mt-3">
            {% if form.instance.pk %}
                수정하기
            {% else %}
                등록하기
            {% endif %}
        </button>
    </form>
</div>

{% comment %} 이미지 미리보기 {% endcomment %}
<div id="image-preview-container" class="my-3">
    <div class="row">
        <div class="col-md-6 text-center">
            {% if form.instance.image1 %}
                <p>등록된 이미지 1</p>
                <img src="{{ form.instance.image1.url }}" alt="Uploaded Image 1" class="img-fluid" id="image-preview1">
            {% endif %}
        </div>
        <div class="col-md-6 text-center">
            {% if form.instance.image2 %}
                <p>등록된 이미지 2</p>
                <img src="{{ form.instance.image2.url }}" alt="Uploaded Image 2" class="img-fluid" id="image-preview2">
            {% endif %}
        </div>
        <div class="col-md-6 text-center">
            {% if form.instance.image3 %}
                <p>등록된 이미지 3</p>
                <img src="{{ form.instance.image3.url }}" alt="Uploaded Image 3" class="img-fluid" id="image-preview3">
            {% endif %}
        <div class="col-md-6 text-center">
            {% if form.instance.image4 %}
                <p>등록된 이미지 4</p>
                <img src="{{ form.instance.image4.url }}" alt="Uploaded Image 4" class="img-fluid" id="image-preview4">
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    // 팝업창, 이미지 등록 버튼, 확인 버튼 요소 선택
    const modal = $('#uploadModal');  // 팝업창 선택
    const uploadBtn = $('#uploadBtn');  // 업로드 버튼 선택
    const confirmBtn = $('.confirm-btn');  // 확인 버튼 선택

    // 제목과 내용 입력 필드를 선택
    const subjectInput = $('#subject');  // 제목 입력 필드 선택
    const contentInput = $('#content');  // 내용 입력 필드 선택

    // 폼과 이미지 미리보기 컨테이너 선택
    const questionForm = $('#questionForm');  // 폼 요소 선택
    const imagePreviewContainer = $('#image-preview-container');  // 미리보기 컨테이너 선택

    // 이미지 업로드를 위한 설정 배열
    const imageUploadSettings = [
        { input: '#image1', dropZone: '#drop-zone1', previewId: '#preview-image1', mainPreviewId: '#main-preview1 img' },
        { input: '#image2', dropZone: '#drop-zone2', previewId: '#preview-image2', mainPreviewId: '#main-preview2 img' },
        { input: '#image3', dropZone: '#drop-zone3', previewId: '#preview-image3', mainPreviewId: '#main-preview3 img' },
        { input: '#image4', dropZone: '#drop-zone4', previewId: '#preview-image4', mainPreviewId: '#main-preview4 img' }
    ];

    // 이미지 드래그 앤 드롭 및 파일 선택을 처리하는 함수
    function setupImageUpload(inputSelector, dropZoneSelector, previewId) {
        const $dropZone = $(dropZoneSelector);  // 드롭존 선택
        const $fileInput = $(inputSelector);  // 파일 입력 필드 선택
        const $dropText = $dropZone.find('.drop-text');  // 드롭존 안내 문구 선택
        const $imagePreview = $(previewId);  // 이미지 미리보기 선택

        // 드래그 중일 때 드롭존 스타일 변경
        $dropZone.on('dragover', function(event) {
            event.preventDefault();  // 기본 동작 방지
            $dropZone.addClass('hover');  // 드롭존에 'hover' 클래스 추가
        });

        // 드래그가 끝났을 때 드롭존 스타일 원래대로 변경
        $dropZone.on('dragleave', function() {
            $dropZone.removeClass('hover');  // 'hover' 클래스 제거
        });

        // 드롭된 파일 처리
        $dropZone.on('drop', function(event) {
            event.preventDefault();  // 기본 동작 방지
            $dropZone.removeClass('hover');  // 'hover' 클래스 제거

            const files = event.originalEvent.dataTransfer.files;  // 드롭된 파일 가져오기
            if (files.length > 0 && files[0].type.startsWith('image/')) {  // 파일이 이미지일 경우
                $fileInput[0].files = files;  // 파일 입력 필드에 파일 설정
                $dropText.hide();  // 드롭존 안내 문구 숨기기

                const reader = new FileReader();  // FileReader 객체 생성
                reader.onload = function(e) {
                    $imagePreview.attr('src', e.target.result).show();  // 파일을 미리보기로 표시
                }
                reader.readAsDataURL(files[0]);  // 파일을 읽기 시작
            }
        });

        // 파일 선택 시 처리
        $fileInput.on('change', function(event) {
            if (event.target.files.length > 0) {  // 파일이 선택되었을 경우
                $dropText.hide();  // 드롭존 안내 문구 숨기기
                const reader = new FileReader();  // FileReader 객체 생성
                reader.onload = function(e) {
                    $imagePreview.attr('src', e.target.result).show();  // 파일을 미리보기로 표시
                }
                reader.readAsDataURL(event.target.files[0]);  // 파일을 읽기 시작
            }
        });
    }

    // 제목과 내용이 비어 있는지 확인하고 업로드 버튼 활성화/비활성화
    function checkFormValidity() {
        const subjectValid = subjectInput.val().trim() !== '';  // 제목이 비어있는지 확인
        const contentValid = contentInput.val().trim() !== '';  // 내용이 비어있는지 확인
        uploadBtn.prop('disabled', !(subjectValid && contentValid));  // 제목과 내용이 모두 있으면 버튼 활성화
    }

    // 업로드 버튼 클릭 시 팝업창 표시
    uploadBtn.on('click', function() {
        modal.css('display', 'flex');  // 팝업창을 보여줌
    });

    // 확인 버튼 클릭 시 팝업창 숨기기
    confirmBtn.on('click', function() {
        modal.hide();  // 팝업창 숨기기

        // 이미지 미리보기 업데이트
        imageUploadSettings.forEach(setting => {
            const fileInput = $(setting.input)[0];  // 파일 입력 필드 선택
            const previewImg = $(setting.previewId);  // 미리보기 이미지 선택
            const mainPreviewImg = $(setting.mainPreviewId);  // 메인 미리보기 이미지 선택

            if (fileInput.files.length > 0) {  // 파일이 선택되었을 경우
                const reader = new FileReader();  // FileReader 객체 생성
                reader.onload = function(e) {
                    previewImg.attr('src', e.target.result).show();  // 미리보기를 업데이트
                    mainPreviewImg.attr('src', e.target.result).show();  // 메인 미리보기를 업데이트
                }
                reader.readAsDataURL(fileInput.files[0]);  // 파일을 읽기 시작
            } else {
                const existingImgSrc = mainPreviewImg.attr('src');  // 기존 이미지 소스 가져오기
                if (existingImgSrc) {
                    previewImg.attr('src', existingImgSrc).show();  // 기존 이미지 유지
                }
            }
        });
    });

    // 각 이미지 업로드 설정에 대해 드래그 앤 드롭 및 파일 선택 처리 설정
    imageUploadSettings.forEach(setting => {
        setupImageUpload(setting.input, setting.dropZone, setting.previewId);  // 각 이미지 설정
    });

    // 제목과 내용 입력 필드에 유효성 검사 연결
    subjectInput.add(contentInput).on('input', checkFormValidity);  // 입력 필드가 변경될 때마다 유효성 검사
    checkFormValidity();  // 처음 로드 시 유효성 검사 실행

    // 폼 제출 시 처리
    questionForm.on('submit', function(event) {
        event.preventDefault();  // 폼의 기본 제출 동작을 막음

        const formData = new FormData(this);  // FormData 객체 생성

        // 각 파일 입력 필드에서 선택된 파일을 FormData에 추가
        imageUploadSettings.forEach(setting => {
            const fileInput = $(setting.input)[0];  // 파일 입력 필드 선택
            if (fileInput.files.length > 0) {
                formData.append(fileInput.id, fileInput.files[0]);  // FormData에 파일 추가
            }
        });

        // 폼이 수정 상태인지 확인
        const isModify = '{{ form.instance.pk|yesno:"true,false" }}';  // 수정 상태 여부 확인
        const questionId = '{{ form.instance.pk }}';  // 수정 중인 경우 PK 값 가져오기
        const url = isModify === 'true'
            ? '{% url "pybo:question_modify" question_id=0 %}'.replace('0', questionId)  // 수정 시 URL 설정
            : '{% url "pybo:question_create" %}';  // 생성 시 URL 설정

        // Ajax 요청으로 폼 데이터 전송
        $.ajax({
            url: url,  // 서버로 전송할 URL
            method: 'POST',  // HTTP POST 방식 사용
            data: formData,  // 전송할 데이터
            processData: false,  // FormData 객체의 자동 처리 방지
            contentType: false,  // Content-Type 설정 방지 (자동 설정)
            headers: {'X-CSRFToken': '{{ csrf_token }}'},  // CSRF 토큰 추가
            success: function(response) {
                window.location.href = response.redirect_url;  // 성공 시 리다이렉트
            },
            error: function() {
                alert('이미지를 4장 올려주세요.');  // 오류 발생 시 경고창 표시
            }
        });
    });
});
</script>
{% endblock %}
